services:
  init:
    build:
      context: ..
      dockerfile: Dockerfile
    image: us-docker.pkg.dev/evmchain/images/raiko:latest
    container_name: raiko-init
    command: --init
    env_file:
      - .env
    devices:
      - "/dev/sgx_enclave:/dev/sgx_enclave"
      - "/dev/sgx_provision:/dev/sgx_provision"
    volumes:
      - /var/log/raiko:/var/log/raiko
      - ${HOME}/.config/gramine:/root/.config/gramine
      - ${HOME}/.config/raiko:/root/.config/raiko
    environment:
      - SGX=true
      - SGXGETH=${SGXGETH}
    # environment:
    # you can use your own PCCS host
    #- PCCS_HOST=host.docker.internal:8081
    depends_on:
      - pccs
  init-self-register:
    build:
      context: ..
      args:
        ENABLE_SELF_REGISTER: "true"
      dockerfile: Dockerfile
    image: us-docker.pkg.dev/evmchain/images/raiko:latest
    container_name: raiko-init-self-register
    command: --init-self-register
    env_file:
      - .env
    devices:
      - "/dev/sgx_enclave:/dev/sgx_enclave"
      - "/dev/sgx_provision:/dev/sgx_provision"
    volumes:
      - /var/log/raiko:/var/log/raiko
      - ${HOME}/.config/gramine:/root/.config/gramine
      - ${HOME}/.config/raiko:/root/.config/raiko
      - ${HOME}/.config/raiko/config/config.sgx.json:/etc/raiko/config.sgx.json
    environment:
      - SGX=true
      - SGXGETH=${SGXGETH}
      - SENDER_PRIV_KEY=${SENDER_PRIV_KEY}
      - L1_RPC=${L1_RPC}
      - L1_CHAIN_ID=${L1_CHAIN_ID}
      - SGX_VERIFIER_ADDRESS=${SGX_VERIFIER_ADDRESS}
      - HOLESKY_RPC=${HOLESKY_RPC}
      - HOLESKY_BEACON_RPC=${HOLESKY_BEACON_RPC}
      - TAIKO_A7_RPC=${TAIKO_A7_RPC}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      #- PCCS_HOST=host.docker.internal:8081
    depends_on:
      - pccs
  raiko:
    build:
      context: ..
      dockerfile: Dockerfile
    image: us-docker.pkg.dev/evmchain/images/raiko:latest
    container_name: raiko
    command:
    env_file:
      - .env
    devices:
      - "/dev/sgx_enclave:/dev/sgx_enclave"
      - "/dev/sgx_provision:/dev/sgx_provision"
    volumes:
      - /var/log/raiko:/var/log/raiko
      - ${HOME}/.config/gramine:/root/.config/gramine
      - ${HOME}/.config/raiko:/root/.config/raiko
    ports:
      - "8080:8080"
    environment:
      - SGX=true
      - SGXGETH=${SGXGETH}
      - PREFETCH_CHUNK_SIZE=${PREFETCH_CHUNK_SIZE}
      - BASE_CONFIG_FILE=${BASE_CONFIG_FILE:-config.sgx.json}
      - BASE_CHAINSPEC_FILE=${BASE_CHAINSPEC_FILE:-chain_spec_list.docker.json}
      # Set to 0 (which is the default) to run on real hardware; use 1 for testing
      - SGX_DIRECT=${SGX_DIRECT}
      - SGX_INSTANCE_ID=${SGX_INSTANCE_ID}
      - SGX_ONTAKE_INSTANCE_ID=${SGX_ONTAKE_INSTANCE_ID}
      - SGX_PACAYA_INSTANCE_ID=${SGX_PACAYA_INSTANCE_ID}
      - SGXGETH_PACAYA_INSTANCE_ID=${SGXGETH_PACAYA_INSTANCE_ID}
      - ETHEREUM_RPC=${ETHEREUM_RPC}
      - ETHEREUM_BEACON_RPC=${ETHEREUM_BEACON_RPC}
      - HOLESKY_RPC=${HOLESKY_RPC}
      - HOLESKY_BEACON_RPC=${HOLESKY_BEACON_RPC}
      - TAIKO_A7_RPC=${TAIKO_A7_RPC}
      - TAIKO_MAINNET_RPC=${TAIKO_MAINNET_RPC}
      - L1_NETWORK=${L1_NETWORK}
      - NETWORK=${NETWORK}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - RUST_LOG=${RUST_LOG:-info}
      # you can use your own PCCS host
      #- PCCS_HOST=host.docker.internal:8081
      # use the host's network to connect to the PCCS
      #extra_hosts:
      #  - "host.docker.internal:host-gateway"
    depends_on:
      - redis
      - pccs
    profiles:
      - prod-redis
  raiko-self-register:
    build:
      context: ..
      dockerfile: Dockerfile
    image: us-docker.pkg.dev/evmchain/images/raiko:latest
    container_name: raiko-self-register
    command:
    env_file:
      - .env
    devices:
      - "/dev/sgx_enclave:/dev/sgx_enclave"
      - "/dev/sgx_provision:/dev/sgx_provision"
    volumes:
      - /var/log/raiko:/var/log/raiko
      - ${HOME}/.config/gramine:/root/.config/gramine
      - ${HOME}/.config/raiko:/root/.config/raiko
      - ${HOME}/.config/raiko/config/config.sgx.json:/etc/raiko/config.sgx.json
      - ${HOME}/.config/raiko/config/chain_spec_list.docker.json:/etc/raiko/chain_spec_list.docker.json
    ports:
      - "8080:8080"
    environment:
      # you can use your own PCCS host
      # - PCCS_HOST=host.docker.internal:8081
      - SGX=true
      - SGXGETH=${SGXGETH}
      - BASE_CONFIG_FILE=${BASE_CONFIG_FILE:-config.sgx.json}
      - BASE_CHAINSPEC_FILE=${BASE_CHAINSPEC_FILE:-chain_spec_list.docker.json}
      - ETHEREUM_RPC=${ETHEREUM_RPC}
      - ETHEREUM_BEACON_RPC=${ETHEREUM_BEACON_RPC}
      - HOLESKY_RPC=${HOLESKY_RPC}
      - HOLESKY_BEACON_RPC=${HOLESKY_BEACON_RPC}
      - TAIKO_A7_RPC=${TAIKO_A7_RPC}
      - TAIKO_MAINNET_RPC=${TAIKO_MAINNET_RPC}
      - L1_NETWORK=${L1_NETWORK}
      - NETWORK=${NETWORK}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
    # use the host's network to connect to the PCCS
    #extra_hosts:
    #  - "host.docker.internal:host-gateway"
    depends_on:
      - pccs
  raiko-zk:
    build:
      context: ..
      dockerfile: Dockerfile.zk
    image: us-docker.pkg.dev/evmchain/images/raiko-zk:latest
    container_name: raiko-zk
    command:
    env_file:
      - .env
    volumes:
      - /var/log/raiko:/var/log/raiko
    ports:
      - "8090:8080"
    environment:
      # you can use your own PCCS host
      # - PCCS_HOST=host.docker.internal:8081
      - RUST_LOG=${RUST_LOG:-info}
      - ZK=true
      - PREFETCH_CHUNK_SIZE=${PREFETCH_CHUNK_SIZE}
      - BASE_CONFIG_FILE=${BASE_CONFIG_FILE:-config.sgx.json}
      - BASE_CHAINSPEC_FILE=${BASE_CHAINSPEC_FILE:-chain_spec_list.docker.json}
      - ETHEREUM_RPC=${ETHEREUM_RPC}
      - ETHEREUM_BEACON_RPC=${ETHEREUM_BEACON_RPC}
      - HOLESKY_RPC=${HOLESKY_RPC}
      - HOLESKY_BEACON_RPC=${HOLESKY_BEACON_RPC}
      - TAIKO_A7_RPC=${TAIKO_A7_RPC}
      - TAIKO_MAINNET_RPC=${TAIKO_MAINNET_RPC}
      - L1_NETWORK=${L1_NETWORK}
      - NETWORK=${NETWORK}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      # risc0 service env
      - BONSAI_API_KEY=${BONSAI_API_KEY}
      - BONSAI_API_URL=${BONSAI_API_URL}
      # risc0 verifier
      - GROTH16_VERIFIER_RPC_URL=${GROTH16_VERIFIER_RPC_URL}
      - GROTH16_VERIFIER_ADDRESS=${GROTH16_VERIFIER_ADDRESS}
      # sp1 service env
      - NETWORK_RPC_URL=${NETWORK_RPC_URL}
      - NETWORK_PRIVATE_KEY=${NETWORK_PRIVATE_KEY}
      - SKIP_SIMULATION=true
      # sp1 verifier
      - SP1_VERIFIER_RPC_URL=${SP1_VERIFIER_RPC_URL}
      - SP1_VERIFIER_ADDRESS=${SP1_VERIFIER_ADDRESS}
    depends_on:
      - redis
    profiles:
      - prod-redis
  pccs:
    build:
      context: ..
      dockerfile: Dockerfile.pccs
    image: us-docker.pkg.dev/evmchain/images/pccs:latest
    container_name: pccs
    env_file:
      - .env
    ports:
      - "8081:8081"
    volumes:
      - ${HOME}/.config/sgx-pccs/default.json:/opt/intel/pccs/config/default.json
      - ${HOME}/.config/sgx-pccs/file.crt:/opt/intel/pccs/ssl_key/file.crt
      - ${HOME}/.config/sgx-pccs/private.pem:/opt/intel/pccs/ssl_key/private.pem
  redis:
    image: redis
    container_name: redis
    env_file:
      - .env
    ports:
      - "6379:6379"
    profiles:
      - prod-redis
